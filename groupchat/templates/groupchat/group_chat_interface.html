{% extends 'base.html' %}
{% load static %}
{% load groupchat_extras %} {# Load custom templatetags #}

{% block title %}{{ group.name }} - Chat | {{ platform_name|default:"BookHaven" }}{% endblock %}

{% block head_extra %}
    {# Add specific CSS for chat interface if needed later #}
    {# <link rel="stylesheet" href="{% static 'groupchat/css/chat_styles.css' %}"> #}
    <style>
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px); /* Adjust based on header/footer/padding */
            max-width: 800px;
            margin: auto;
        }
        .message-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e5e7eb; /* Tailwind gray-200 */
            border-radius: 0.5rem;
            background-color: #f9fafb; /* Tailwind gray-50 */
            margin-bottom: 10px; /* Space before form */
        }
        .message-bubble {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        .message-bubble.user-message {
            background-color: #4f46e5; /* Tailwind indigo-600 */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .message-bubble.other-message {
            background-color: #e5e7eb; /* Tailwind gray-200 */
            color: #1f2937; /* Tailwind gray-800 */
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        .message-meta {
            font-size: 0.7rem; /* Slightly smaller */
            color: #6b7280; /* Tailwind gray-500 */
            margin-top: 3px;
        }
        .user-message .message-meta {
            color: #c7d2fe; /* indigo-200 for visibility on dark */
            text-align: right;
        }
        .message-form-container {
            padding: 10px;
            border-top: 1px solid #e5e7eb;
        }
        .file-name {
            display: block;
            font-size: 0.8rem; 
            color: #4b5563; 
            margin-top: 4px;
            padding: 4px 6px;
            background-color: #f3f4f6; 
            border-radius: 4px;
            border: 1px solid #d1d5db; 
        }
        .message-bubble a.file-link {
            color: inherit; 
            text-decoration: underline;
        }
        .user-message a.file-link {
            color: #c7d2fe; 
        }
        .other-message a.file-link {
             color: #374151; 
        }
        .form-field-container {
            display: flex;
            align-items: flex-end; /* Align items to bottom for better textarea + button look */
            gap: 0.75rem; /* space-x-3 */
        }
        .form-field-container textarea {
            flex-grow: 1;
            /* Specific classes already on widget */
        }
        .form-field-container button[type="submit"] {
             /* Specific classes already on button */
             white-space: nowrap; /* Prevent Send button text from wrapping */
        }
        .file-input-label {
            padding: 0.75rem; /* p-3 */
            background-color: #e5e7eb; /* bg-gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            color: #374151; /* text-gray-700 */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-input-label:hover {
            background-color: #d1d5db; /* bg-gray-300 */
        }
        /* Ensure form errors defined in forms.py (if any) are styled */
        .errorlist {
            list-style-type: none;
            padding: 0;
            margin: 0 0 0.5em 0;
            color: #dc2626; /* red-600 */
            font-size: 0.875rem; /* text-sm */
        }
        .errorlist li {
            margin-bottom: 0.25rem;
        }
    </style>
{% endblock %}

{% block main_class %}pt-16 pb-2 bg-gray-100{% endblock %}

{% block content %}
<div class="container mx-auto px-2 sm:px-4 py-4">
    <div class="bg-white shadow-xl rounded-lg flex flex-col max-h-[calc(100vh-100px)] overflow-hidden"> 
        <header class="p-4 sm:p-6 border-b border-gray-200">
            <h1 class="text-2xl sm:text-3xl font-bold text-indigo-700">{{ group.name }} - Chat</h1>
            <p class="text-sm text-gray-600">Discussing: {{ group.content_item.title }}</p>
        </header>

        <div class="message-list flex-grow">
            {% if messages %}
                {% for message_item in messages %} {# Renamed to message_item to avoid clash with django messages #}
                    <div class="message-bubble {% if message_item.user == request.user %}user-message{% else %}other-message{% endif %}">
                        {% if message_item.user != request.user %}
                            <strong class="block text-sm mb-1">{{ message_item.user.first_name|default:message_item.user.username }}</strong>
                        {% endif %}
                        
                        {% if message_item.text_content %}
                            <p>{{ message_item.text_content|linebreaksbr }}</p>
                        {% endif %}
                        
                        {% if message_item.file_attachment %}
                            <a href="{{ message_item.file_attachment.url }}" target="_blank" class="file-link mt-2 inline-block hover:underline">
                                <span class="file-name">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 align-middle" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a3 3 0 006 0V7a1 1 0 112 0v4a5 5 0 01-10 0V7a3 3 0 013-3h1z" clip-rule="evenodd" /></svg>
                                    {{ message_item.file_attachment.name|filename_only }}
                                </span>
                            </a>
                        {% endif %}
                        <div class="message-meta mt-1">
                            {{ message_item.timestamp|date:"P, M d, Y" }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-center text-gray-500 py-10">No messages in this group yet. Start the conversation!</p>
            {% endif %}
        </div>

        <div class="message-form-container p-3 border-t border-gray-200 bg-gray-50">
            <form method="post" enctype="multipart/form-data" class="form-field-container">
                {% csrf_token %}
                
                {# Render form fields individually for better control if needed, or as_p/as_table #}
                {{ form.text_content }} 
                
                <label for="{{ form.file_attachment.id_for_label }}" class="file-input-label">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>
                </label>
                {{ form.file_attachment }} {# This is hidden by widget attrs, label above triggers it #}

                <button id="send-message-button" type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-5 rounded-lg transition">
                    Send
                </button>
            </form>
            {% if form.file_attachment.errors %}
                <ul class="errorlist">
                {% for error in form.file_attachment.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
            {% endif %}
            {% if form.text_content.errors %}
                <ul class="errorlist">
                {% for error in form.text_content.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
            {% endif %}
            {% if form.non_field_errors %}
                 <ul class="errorlist">
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
            {% endif %}
            <p id="file-chosen-feedback" class="text-xs text-gray-500 mt-1 ml-1"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const messageList = document.querySelector('.message-list');
        if (messageList) {
            messageList.scrollTop = messageList.scrollHeight;
        }

        const fileInput = document.getElementById('{{ form.file_attachment.id_for_label }}'); // Matches ID from forms.py
        const fileChosenFeedback = document.getElementById('file-chosen-feedback');
        const textInput = document.getElementById('{{ form.text_content.id_for_label }}'); // Django default ID
        const sendButton = document.getElementById('send-message-button');

        function updateSendButtonState() {
            const textValue = textInput ? textInput.value.trim() : '';
            const fileSelected = fileInput ? fileInput.files.length > 0 : false;
            if (sendButton) {
                sendButton.disabled = !(textValue || fileSelected);
            }
        }

        if (fileInput) {
            fileInput.addEventListener('change', function() {
                if (fileChosenFeedback) {
                    if (this.files.length > 0) {
                        fileChosenFeedback.textContent = `File selected: ${this.files[0].name}`;
                    } else {
                        fileChosenFeedback.textContent = '';
                    }
                }
                updateSendButtonState();
            });
        }

        if (textInput) {
            textInput.addEventListener('input', updateSendButtonState);
        }

        // Initial state update
        updateSendButtonState();
        
        const textarea = document.querySelector('.form-field-container textarea'); // Already selected earlier
        if (textarea) { // Ensure this uses the 'textInput' const if they are the same element.
                      // For now, assuming 'textarea' might be a more generic selector for styling, 
                      // and 'textInput' (by ID) is for logic.
            function autoResizeTextarea() {
                textarea.style.height = 'auto';
                let newHeight = textarea.scrollHeight;
                textarea.style.height = newHeight + 'px';

                // Adjust overall chat layout if textarea grows significantly
                const messageFormContainer = document.querySelector('.message-form-container');
                const chatContainer = document.querySelector('.bg-white.shadow-xl.rounded-lg'); // Main chat box
                if (messageList && messageFormContainer && chatContainer) {
                    // Example: messageList.style.maxHeight = `calc(100% - ${messageFormContainer.offsetHeight}px - ${chatContainer.querySelector('header').offsetHeight}px)`
                }
            }
            textarea.addEventListener('input', autoResizeTextarea);
            autoResizeTextarea(); // Initial call
        }
    });
</script>
{% endblock %} 