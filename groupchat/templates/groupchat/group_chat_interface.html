{% extends 'base.html' %}
{% load static %}
{% load groupchat_extras %} {# Load custom templatetags #}

{% block title %}{{ group.name }} - Chat | {{ platform_name|default:"BookHaven" }}{% endblock %}

{% block head_extra %}
    {# Add specific CSS for chat interface if needed later #}
    {# <link rel="stylesheet" href="{% static 'groupchat/css/chat_styles.css' %}"> #}
    <style>
        .chat-content-area { /* New wrapper for chat within the main content block */
            display: flex;
            flex-direction: column;
            /* Height will be 100% of its container if content block allows, or set explicitly if needed */
            /* e.g., height: calc(100vh - HeaderHeight - FooterHeight - ContentPaddingY); */
            /* For now, let's aim for a large fixed height, adjust based on testing with header/footer */
            height: calc(100vh - 200px); /* Placeholder: Adjust 200px based on actual header/footer/padding */
            max-width: 900px; 
            margin: 0 auto; /* Center it if max-width is used */
            background-color: #fff; /* White background for the chat area itself */
            border: 1px solid #e5e7eb; /* Border around the chat area */
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden; /* Prevent content from spilling if height calculations are tricky */
        }
        .chat-internal-header {
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid #e5e7eb; 
            flex-shrink: 0; 
            background-color: #f9fafb; /* Light gray for this header section */
        }
        .chat-internal-header h2 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* semibold */
            color: #4f46e5; /* indigo-600 */
        }
        .chat-internal-header p {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* gray-500 */
        }
        .message-list-wrapper {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #f9fafb; 
        }
        .message-bubble {
            max-width: 75%;
            width: fit-content; 
            padding: 10px 15px;
            border-radius: 18px; 
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        .message-bubble.user-message {
            background-color: #4f46e5; 
            color: white;
            margin-left: auto; /* User messages to the right */
        }
        .message-bubble.other-message {
            background-color: #e5e7eb; 
            color: #1f2937; 
            margin-right: auto; /* Other messages to the left */
        }
        .message-meta {
            font-size: 0.75rem; 
            color: #6b7280; 
            margin-top: 4px;
        }
        .user-message .message-meta {
            color: #c7d2fe; 
            text-align: right;
        }
        .message-form-wrapper {
            padding: 12px;
            background-color: #f3f4f6; /* Slightly different gray for input area */
            border-top: 1px solid #e5e7eb; 
            flex-shrink: 0; 
        }
        .form-field-container {
            display: flex;
            align-items: flex-end; 
            gap: 0.75rem; 
        }
        .form-field-container textarea {
            flex-grow: 1;
        }
        .file-input-label, button[type="submit"] {
            white-space: nowrap;
        }
        .file-input-label {
            padding: 0.65rem; /* Adjusted padding */
        }
        button[type="submit"] {
             padding: 0.65rem 1.25rem; /* Adjusted padding */
        }
        .file-name-feedback, .errorlist {
            margin-top: 5px;
            margin-left: 5px;
        }
    </style>
{% endblock %}

{% block content %} {# Chat interface now lives within the standard content block #}
<div class="chat-content-area">
    <div class="chat-internal-header">
        <h2>{{ group.name }}</h2>
        <p>Focus: {{ group.content_item.title }}</p>
    </div>

    <div class="message-list-wrapper">
        {% if messages %}
            {% for message_item in messages %}
                <div class="message-bubble {% if message_item.user == request.user %}user-message{% else %}other-message{% endif %}">
                    {% if message_item.user == request.user %}
                        <strong class="block text-sm mb-1">You</strong>
                    {% else %}
                        <strong class="block text-sm mb-1">{{ message_item.user.get_full_name|default:message_item.user.username }}</strong>
                    {% endif %}
                    {% if message_item.text_content %}<p>{{ message_item.text_content|linebreaksbr }}</p>{% endif %}
                    {% if message_item.file_attachment %}
                        <a href="{{ message_item.file_attachment.url }}" target="_blank" class="file-link mt-2 inline-block hover:underline">
                            <span class="file-name">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 align-middle" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a3 3 0 006 0V7a1 1 0 112 0v4a5 5 0 01-10 0V7a3 3 0 013-3h1z" clip-rule="evenodd" /></svg>
                                {{ message_item.file_attachment.name|filename_only }}
                            </span>
                        </a>
                    {% endif %}
                    <div class="message-meta">{{ message_item.timestamp|date:"P, M d, Y" }}</div>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-center text-gray-500 py-10">No messages yet. Start the conversation!</p>
        {% endif %}
    </div>

    <div class="message-form-wrapper">
        <form method="post" enctype="multipart/form-data" class="form-field-container">
            {% csrf_token %}
            {{ form.text_content }} 
            <label for="{{ form.file_attachment.id_for_label }}" class="file-input-label">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>
            </label>
            {{ form.file_attachment }} 
            <button id="send-message-button" type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition">
                Send
            </button>
        </form>
        <p id="file-chosen-feedback" class="file-name-feedback"></p>
        {% if form.non_field_errors %}
             <ul class="errorlist">
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
            </ul>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const messageListWrapper = document.querySelector('.message-list-wrapper');
        if (messageListWrapper) {
            messageListWrapper.scrollTop = messageListWrapper.scrollHeight;
        }

        const textInput = document.getElementById('{{ form.text_content.id_for_label }}');
        if (textInput) {
            textInput.focus(); // Autofocus
        }

        const fileInput = document.getElementById('{{ form.file_attachment.id_for_label }}');
        const fileChosenFeedback = document.getElementById('file-chosen-feedback');
        const sendButton = document.getElementById('send-message-button');

        function updateSendButtonState() {
            const textValue = textInput ? textInput.value.trim() : '';
            const fileSelected = fileInput ? fileInput.files.length > 0 : false;
            if (sendButton) {
                sendButton.disabled = !(textValue || fileSelected);
            }
        }

        if (fileInput) {
            fileInput.addEventListener('change', function() {
                if (fileChosenFeedback) {
                    if (this.files.length > 0) {
                        fileChosenFeedback.textContent = `Selected: ${this.files[0].name}`;
                    } else {
                        fileChosenFeedback.textContent = '';
                    }
                }
                updateSendButtonState();
            });
        }

        if (textInput) {
            textInput.addEventListener('input', updateSendButtonState);
            // Corrected: Event listener for Enter/Shift+Enter should be on textInput
            textInput.addEventListener('keydown', function(event) { 
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault(); 
                    if (sendButton && !sendButton.disabled) {
                        sendButton.click(); 
                    }
                } 
            });

            // Auto-resize textarea logic
            function autoResizeTextarea() {
                textInput.style.height = 'auto';
                let newHeight = textInput.scrollHeight;
                // Add a small buffer or max-height to prevent infinite growth if desired
                // For now, just set to scrollHeight. Consider a max-height CSS rule too.
                textInput.style.height = newHeight + 'px';
            }
            textInput.addEventListener('input', autoResizeTextarea);
            autoResizeTextarea(); // Initial call for existing content
        }
        updateSendButtonState(); // Initial state for the send button
    });
</script>
{% endblock %} 